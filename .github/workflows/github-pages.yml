name: Deploy Paketti GitHub Pages with Dark Mode

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Prepare a temporary README.md for deployment
      - name: Process README for Deployment
        run: |
          cp README.md README_DEPLOY.md  # Keep the original README.md unchanged
          
          # Add dark-mode.css link at the top if it's not already there
          if ! grep -q 'dark-mode.css' README_DEPLOY.md; then
            echo '<link rel="stylesheet" href="dark-mode.css">' | cat - README_DEPLOY.md > temp && mv temp README_DEPLOY.md
            echo "Added dark-mode.css to README_DEPLOY.md"
          fi
          
          # Append paketti_updates.md under "## Changeslog" if not already there
          if [ -f paketti_updates.md ]; then
            if ! grep -q '## Changeslog' README_DEPLOY.md; then
              echo -e "\n\n## Changeslog\n" >> README_DEPLOY.md
              cat paketti_updates.md >> README_DEPLOY.md
              echo "Changeslog appended to README_DEPLOY.md"
            else
              echo "Changeslog already exists in README_DEPLOY.md. Skipping."
            fi
          else
            echo "paketti_updates.md not found. Skipping."
          fi

      # Deploy to GitHub Pages using README_DEPLOY.md
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          exclude: "README.md"  # Prevents the unmodified README.md from being uploaded
          include: "README_DEPLOY.md"  # Ensures the modified file is used
