name: Deploy Paketti GitHub Pages with Dark Mode

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Identify the main manual file
      - name: Identify Manual File
        run: |
          MANUAL_FILE="index.md"  # Change this if your manual is a different file
          echo "MANUAL_FILE=$MANUAL_FILE" >> $GITHUB_ENV

      # Ensure dark-mode.css is included at the top of the manual
      - name: Add Dark Mode CSS to Manual
        run: |
          if ! grep -q 'dark-mode.css' "$MANUAL_FILE"; then
            echo '<link rel="stylesheet" href="dark-mode.css">' | cat - "$MANUAL_FILE" > temp && mv temp "$MANUAL_FILE"
            echo "Added dark-mode.css to $MANUAL_FILE"
          else
            echo "dark-mode.css already present in $MANUAL_FILE"
          fi

      # Append paketti_updates.md to the manual file (NOT README.md)
      - name: Append Changeslog to Manual File
        run: |
          if [ -f paketti_updates.md ]; then
            if ! grep -q '## Changeslog' "$MANUAL_FILE"; then
              echo -e "\n\n## Changeslog\n" >> "$MANUAL_FILE"
              cat paketti_updates.md >> "$MANUAL_FILE"
              echo "Changeslog appended to $MANUAL_FILE"
            else
              echo "Changeslog already exists in $MANUAL_FILE. Skipping."
            fi
          else
            echo "paketti_updates.md not found. Skipping."
          fi

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
